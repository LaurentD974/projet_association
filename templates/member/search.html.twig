{% extends 'base.html.twig' %}

{% block body %}
<header class="search-header">
  <h1 class="search-title">Trombinoscope</h1>
  <div class="search-actions">
    <a href="{{ path('app_profile') }}" class="btn btn-warning">Modifier mon profil</a>
    <a href="{{ path('app_logout') }}" class="btn btn-danger">Se d√©connecter</a>
    <a href="{{ path('app_planning') }}" class="btn btn-primary">Voir le planning</a>
    <a href="{{ path('home') }}" class="btn btn-outline-secondary">üè† Accueil</a>
    {% if app.user and 'ROLE_GACHEUR' in app.user.roles or 'ROLE_ADMIN' in app.user.roles %}
  <a 
    href="{% if 'ROLE_ADMIN' in app.user.roles %}{{ path('admin_dashboard') }}{% else %}{{ path('gacheur_dashboard') }}{% endif %}" 
    class="btn {% if 'ROLE_ADMIN' in app.user.roles %}btn-dark{% else %}btn-success{% endif %}"
  >
    {% if 'ROLE_ADMIN' in app.user.roles %}
      üõ†Ô∏è Dashboard Admin
    {% else %}
      üéØ Dashboard G√¢cheur
    {% endif %}
  </a>
{% endif %}
  </div>
</header>

<h2>Recherche dynamique des membres</h2>

<form id="filter-form" style="margin-bottom: 20px;">
  <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
    <select name="metier" id="metier-select" class="form-select" style="width: 200px;">
      <option value="">Tous les m√©tiers</option>
    </select>

    <select name="ville" id="ville-select" class="form-select" style="width: 200px;">
      <option value="">Toutes les villes</option>
    </select>

    <select name="fonction1" id="fonction-select" class="form-select" style="width: 200px;">
      <option value="">Toutes les fonctions</option>
    </select>

    <span id="result-count" style="font-weight: bold; margin-left: 10px;">
      0 r√©sultat(s)
    </span>
  </div>
</form>

<div id="member-results" class="member-list">
  <p>Les r√©sultats s‚Äôafficheront ici...</p>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const metierSelect = document.getElementById('metier-select');
  const villeSelect = document.getElementById('ville-select');
  const fonctionSelect = document.getElementById('fonction-select');
  const resultList = document.getElementById('member-results');
  const resultCount = document.getElementById('result-count');
  const form = document.getElementById('filter-form');
  const photoBaseUrl = '{{ asset("uploads/photos") }}/';
  const defaultAvatarUrl = '{{ asset("image/default-avatar.png") }}';

  fetch('/api/filters')
    .then(response => response.json())
    .then(data => {
      data.metiers.forEach(m => {
        metierSelect.innerHTML += `<option value="${m}">${m}</option>`;
      });
      data.villes.forEach(v => {
        villeSelect.innerHTML += `<option value="${v}">${v}</option>`;
      });
      data.fonctions.forEach(f => {
        fonctionSelect.innerHTML += `<option value="${f}">${f}</option>`;
      });
    });

  function fetchMembers() {
    const params = new URLSearchParams(new FormData(form)).toString();
    fetch('/api/members?' + params)
      .then(response => response.json())
      .then(data => {
        resultList.innerHTML = '';
        resultCount.textContent = `${data.length} r√©sultat(s)`;

        if (data.length === 0) {
          resultList.innerHTML = '<p>Aucun membre trouv√© pour ces crit√®res.</p>';
        } else {
          data.forEach(member => {
            console.log(member);
            let photoUrl = member.photo && member.photo.trim() !== ''
              ? photoBaseUrl + member.photo
              : defaultAvatarUrl;

      let cardHTML = `
  <div class="member-card">
    <div class="member-photo-container">
      <img src="${photoUrl}" alt="Photo de ${member.prenom}" class="member-photo">
    </div>
    <div class="member-info">
      <h2>${member.prenom} ${member.nom}</h2>
      <p><strong>M√©tier :</strong> ${member.metier}</p>
      <p><strong>√âtat :</strong> ${member.statut} ${member.position}</p>
      <p><strong>Ville :</strong> ${member.ville}</p>
      <p><strong>Fonction :</strong> ${member.fonction1} <br> ${member.fonction2} </p>
      <div class="card-footer">
        <a href="/member/show/${member.id}" class="btn btn-primary">Voir le profil</a>
      </div>
    </div>
  </div>
`;
            resultList.innerHTML += cardHTML;
          });
        }
      })
      .catch(error => {
        console.error('Erreur lors du chargement des membres :', error);
        resultList.innerHTML = '<p>Une erreur est survenue. Veuillez r√©essayer.</p>';
        resultCount.textContent = '0 r√©sultat(s)';
      });
  }

  fetchMembers();
  form.addEventListener('change', fetchMembers);
});
</script>
{% endblock %}