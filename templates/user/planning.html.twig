{% extends 'base.html.twig' %}
{% set hide_footer = true %}

{% block title %}Planning{% endblock %}

{% block stylesheets %}
  {# <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet"> #}
  <style>
    .fc-toolbar-title {
      font-size: 1.5rem;
      color: #2c3e50;
    }
    body {
  background: linear-gradient(135deg, #b39f6b, #e8eaeb);
  min-height: 100vh;
  margin: 0;
  padding: 0;
}
    #calendar {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    .titre-planning {
      text-align: center;
      margin: 20px auto 10px 0;
      font-size: 2rem;
      color: black;
      max-width: 900px;
    }
    .fc-event-time {
      font-weight: bold;
      font-size: 0.9rem;
    }
    .fc-event-title {
      font-size: 0.85rem;
      color: #f9f9f9;
    }
    .planning-actions {
      max-width: 900px;
      margin: 10px auto 0 auto;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .planning-actions .btn {
      padding: 6px 12px;
  margin-top: 20px; /* ou plus selon le rendu souhait√© */
      font-size: 0.9rem;
      border-radius: 6px;
      text-decoration: none;
    }
    .btn-marron {
  background-color: #8B4513;
  color: white;
  border: none;
}

.btn-marron:hover {
  background-color: #A0522D;
}


  #newsCarousel {
    max-width: 900px;
    margin: 2px auto;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .carousel-item h4,
  .carousel-item p {
    margin: 0;
    padding: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .carousel-item {
    min-height: auto;
  }
.carousel-banner {
  background-color: #f8f9fa;
  padding: 4px 8px;
  min-height: 60px;
}


.carousel-title,
.carousel-content {
  display: inline-block;
  vertical-align: middle;
  margin: 0;
  font-size: 1rem;
}


.carousel-title {
  color: brown;
  font-weight: 600;
}


.carousel-content {
  color: #333;
  margin-left: 1cm; /* espace d‚Äôun centim√®tre entre titre et contenu */
}



  </style>
{% endblock %}

{% block body %}
<div id="newsCarousel" class="carousel slide" data-bs-ride="carousel">
  <!-- Indicateurs -->
  <div class="carousel-indicators">
    {% for news in news_list %}
      <button type="button"
              data-bs-target="#newsCarousel"
              data-bs-slide-to="{{ loop.index0 }}"
              class="{% if loop.first %}active{% endif %}"
              aria-current="{% if loop.first %}true{% endif %}"
              aria-label="Slide {{ loop.index }}">
      </button>
    {% endfor %}
  </div>

  <!-- Slides -->
  <div class="carousel-inner">
    {% for news in news_list %}
      {% if news.title or news.content %}
      <div class="carousel-item {% if loop.first %}active{% endif %}">
  <div class="carousel-banner px-4 py-2">
    <h4 class="carousel-title mb-0 d-inline-block">{{ news.title }}</h4>
    <p class="carousel-content mb-0 d-inline-block ms-4">{{ news.content }}</p>
  </div>
</div>
      {% endif %}
    {% endfor %}
  </div>

 

  <div class="planning-actions">
    <h2 class="titre-planning">PLANNING DE L'ASSOCIATION</h2>
    <a href="{{ path('user_search') }}" class="btn btn-marron">üîô Trombinoscope</a>
    <a href="{{ path('home') }}" class="btn btn-marron">üè† Accueil</a>
    {% if app.user and 'ROLE_GACHEUR' in app.user.roles or 'ROLE_ADMIN' in app.user.roles %}
      <a 
        href="{% if 'ROLE_ADMIN' in app.user.roles %}{{ path('admin_dashboard') }}{% else %}{{ path('gacheur_dashboard') }}{% endif %}" 
        class="btn {% if 'ROLE_ADMIN' in app.user.roles %}btn-dark{% else %}btn-success{% endif %}"
      >
        {% if 'ROLE_ADMIN' in app.user.roles %}
          üõ†Ô∏è Dashboard Admin
        {% else %}
          üéØ Dashboard G√¢cheur
        {% endif %}
      </a>
    {% endif %}
  </div>

  <div id="calendar"></div>
{% endblock %}

{% block javascripts %}
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'fr',
        titleFormat: { year: 'numeric', month: 'long' },
        events: '/api/events',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        eventContent: function(arg) {
          const timeEl = document.createElement('div');
          timeEl.classList.add('fc-event-time');
          timeEl.textContent = arg.timeText;

          const titleEl = document.createElement('div');
          titleEl.classList.add('fc-event-title');
          titleEl.textContent = arg.event.title;

          return { domNodes: [timeEl, titleEl] };
        },
        eventDidMount: function(info) {
          const e = info.event;
          const props = e.extendedProps;

          let description = `
            <strong>${e.title}</strong><br>
            üïí Heure : ${info.timeText}<br>
            üìÖ D√©but : ${e.start.toLocaleString()}<br>
            üìç Lieu : ${props.location || 'Non pr√©cis√©'}<br>
            üè∑Ô∏è Type : ${props.type || 'Non sp√©cifi√©'}<br>
            üìÉ Description : ${props.description || 'Pas de description'}
          `;
          tippy(info.el, {
            content: description,
            allowHTML: true,
            theme: 'light',
            animation: 'fade',
            placement: 'top'
          });
        },
        eventClick: function(info) {
          const e = info.event;
          const props = e.extendedProps;

          const startDate = new Date(e.start);
          const endDate = new Date(startDate.getTime() + 4 * 60 * 60 * 1000);

          const pad = v => v.toString().padStart(2, '0');
          const formatGoogle = date =>
            date.getUTCFullYear() +
            pad(date.getUTCMonth() + 1) +
            pad(date.getUTCDate()) + 'T' +
            pad(date.getUTCHours()) +
            pad(date.getUTCMinutes()) +
            '00Z';

          const gStart = formatGoogle(startDate);
          const gEnd = formatGoogle(endDate);
          const title = encodeURIComponent(e.title);
          const location = encodeURIComponent(props.location || '');
          const details = encodeURIComponent(
            `${props.description || 'Pas de description'}\nType: ${props.type || 'Non sp√©cifi√©'}`
          );

          const googleLink = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${gStart}/${gEnd}&details=${details}&location=${location}`;
          const outlookLink = `https://outlook.live.com/owa/?rru=addevent&subject=${title}&location=${location}&body=${details}&startdt=${startDate.toISOString()}&enddt=${endDate.toISOString()}`;

          const modal = document.createElement('div');
          modal.innerHTML = `
            <div style="padding:20px; font-family: Arial, sans-serif;">
                         <h3 style="margin-top:0;">${e.title}</h3>
              <p><strong>D√©but :</strong> ${startDate.toLocaleDateString()}</p>
              <p><strong>Fin :</strong> ${endDate.toLocaleString()}</p>
              <p><strong>Lieu :</strong> ${props.location || 'Non renseign√©'}</p>
              <p><strong>Type :</strong> ${props.type || 'Non pr√©cis√©'}</p>
              <p><strong>Description :</strong> ${props.description || 'Pas de description'}</p>
              <hr>
              <p>
                üìÜ <a href="${googleLink}" target="_blank">Ajouter √† Google Agenda</a><br>
                üìß <a href="${outlookLink}" target="_blank">Ajouter √† Outlook</a>
              </p>
            </div>
          `;
          Object.assign(modal.style, {
            position: 'fixed',
            top: '20%',
            left: '50%',
            transform: 'translateX(-50%)',
            background: '#fff',
            border: '1px solid #ccc',
            padding: '20px',
            zIndex: 9999,
            boxShadow: '0 0 20px rgba(0,0,0,0.2)',
            borderRadius: '8px',
            maxWidth: '400px',
          });
          document.body.appendChild(modal);

          document.addEventListener('click', function hideModal(ev) {
            if (!modal.contains(ev.target)) {
              modal.remove();
              document.removeEventListener('click', hideModal);
            }
          });
        },
        eventColor: '#27ae60',
        eventDisplay: 'block',
        loading: function(isLoading) {
          calendarEl.classList.toggle('loading', isLoading);
        }
      });
      calendar.render();
    });
  </script>
{% endblock %}